<?xml version="1.0" encoding="UTF-8"?>

<project name="drush-database" default="database:update">

  <!-- ## Properties -->

  <property name="drush.bin"     value="${project.basedir}/bin/drush" />
  <property name="drush.cmd"     value="${drush.bin}" />
  <property name="drush.source"  value="" />
  <property name="drush.target"  value="@${phing.project.name}.local" />
  <property name="drush.tmpdir"  value="/tmp" />

  <!-- ## Targets -->

  <target name="database:update"
          description="Performs database updates.">
    <fail unless="drush.target"
          message="Please provide a drush.target property." />

    <exec command="${drush.cmd} ${drush.target} updb -y"
          passthru="true"
          logoutput="true"
          checkreturn="true" />
  </target>

  <target name="database:drop"
          description="Drops a database.">
    <fail unless="drush.target"
          message="Please provide a drush.target property." />

    <exec command="${drush.cmd} ${drush.target} sql-drop -y"
          passthru="true"
          logoutput="true"
          checkreturn="true" />
  </target>

  <target name="database:sync"
          description="Synchronises the database from source to target."
          depends="database:drop">
    <fail unless="drush.source"
          message="Please provide a drush.source property." />
    <fail unless="drush.target"
          message="Please provide a drush.target property." />

    <exec command="${drush.cmd} sql-sync ${drush.source} ${drush.target} -y --no-cache"
          passthru="true"
          logoutput="true"
          checkreturn="true" />
  </target>

  <target name="database:sync-cached"
          description="Synchronises the database from source to target with dump cached locally."
          depends="database:drop">
    <fail unless="drush.source"
          message="Please provide a drush.source property." />
    <fail unless="drush.target"
          message="Please provide a drush.target property." />

    <exec command="${drush.cmd} sql-sync ${drush.source} ${drush.target} -y --target-dump=${drush.tmpdir}/${phing.project.name}.sync.sql"
          passthru="true"
          logoutput="true"
          checkreturn="true" />
  </target>

</project>
